#!/usr/bin/env python3
"""
Theme Generator for Dotfiles
Generates configuration files from YAML theme definitions and templates
"""

import yaml
import os
import sys
import argparse
from pathlib import Path
from string import Template
import shutil
from datetime import datetime


class ThemeGenerator:
    def __init__(self, config_dir=None):
        if config_dir:
            self.config_dir = Path(config_dir)
        else:
            self.config_dir = Path.home() / ".config" / "theme-manager"
        
        self.themes_dir = self.config_dir / "themes"
        self.templates_dir = self.config_dir / "templates"
        self.current_theme_file = self.config_dir / "current.yaml"
        
    def load_theme(self, theme_path):
        """Load theme from YAML file"""
        with open(theme_path, 'r') as f:
            return yaml.safe_load(f)
    
    def flatten_dict(self, d, parent_key='', sep='_'):
        """Flatten nested dictionary for template substitution"""
        items = []
        for k, v in d.items():
            new_key = f"{parent_key}{sep}{k}" if parent_key else k
            if isinstance(v, dict):
                items.extend(self.flatten_dict(v, new_key, sep=sep).items())
            else:
                items.append((new_key, v))
        return dict(items)
    
    def generate_from_template(self, template_path, theme_data, output_path):
        """Generate config file from template"""
        with open(template_path, 'r') as f:
            template_content = f.read()
        
        # Flatten theme data for substitution
        flat_data = self.flatten_dict(theme_data)
        
        # Use Template for substitution
        template = Template(template_content)
        
        try:
            output_content = template.safe_substitute(flat_data)
        except Exception as e:
            print(f"Error processing template {template_path}: {e}")
            return False
        
        # Ensure output directory exists
        output_path.parent.mkdir(parents=True, exist_ok=True)
        
        # Backup existing file if it exists
        if output_path.exists():
            backup_path = output_path.with_suffix(output_path.suffix + '.backup')
            shutil.copy2(output_path, backup_path)
        
        # Write output
        with open(output_path, 'w') as f:
            f.write(output_content)
        
        return True
    
    def apply_theme(self, theme_name):
        """Apply a theme by generating all config files"""
        theme_path = self.themes_dir / f"{theme_name}.yaml"
        
        if not theme_path.exists():
            print(f"Error: Theme '{theme_name}' not found at {theme_path}")
            return False
        
        print(f"Loading theme: {theme_name}")
        theme_data = self.load_theme(theme_path)
        
        # Save as current theme
        shutil.copy2(theme_path, self.current_theme_file)
        
        # Template mapping: template_file -> output_path
        template_map = {
            'rofi.rasi.template': Path.home() / '.config' / 'rofi' / 'theme.rasi',
            'waybar.css.template': Path.home() / '.config' / 'waybar' / 'theme.css',
            'kitty.conf.template': Path.home() / '.config' / 'kitty' / 'colorscheme.conf',
            'mako.conf.template': Path.home() / '.config' / 'mako' / 'config',
            'dolphin.colors.template': Path.home() / '.local' / 'share' / 'color-schemes' / 'theme.colors',
        }
        
        success_count = 0
        for template_name, output_path in template_map.items():
            template_path = self.templates_dir / template_name
            
            if not template_path.exists():
                print(f"Warning: Template {template_name} not found, skipping...")
                continue
            
            print(f"Generating: {output_path}")
            if self.generate_from_template(template_path, theme_data, output_path):
                success_count += 1
            else:
                print(f"Failed to generate {output_path}")
        
        print(f"\nâœ“ Theme '{theme_name}' applied successfully!")
        print(f"  Generated {success_count} config files")
        print(f"\nReload your applications to see changes:")
        print(f"  - Waybar: killall waybar && waybar &")
        print(f"  - Mako: makoctl reload")
        print(f"  - Kitty: (will apply on next launch)")
        
        return True
    
    def list_themes(self):
        """List available themes"""
        if not self.themes_dir.exists():
            print("No themes directory found")
            return
        
        themes = list(self.themes_dir.glob("*.yaml"))
        
        if not themes:
            print("No themes found")
            return
        
        print("Available themes:")
        for theme_path in sorted(themes):
            theme_data = self.load_theme(theme_path)
            theme_name = theme_path.stem
            variant = theme_data.get('variant', 'unknown')
            author = theme_data.get('author', 'unknown')
            
            current = " (current)" if self.current_theme_file.exists() and \
                     self.load_theme(self.current_theme_file).get('name') == theme_data.get('name') else ""
            
            print(f"  - {theme_name} [{variant}] by {author}{current}")
    
    def init_structure(self):
        """Initialize theme manager directory structure"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        self.themes_dir.mkdir(parents=True, exist_ok=True)
        self.templates_dir.mkdir(parents=True, exist_ok=True)
        
        print(f"Initialized theme manager at: {self.config_dir}")
        print(f"  Themes: {self.themes_dir}")
        print(f"  Templates: {self.templates_dir}")


def main():
    parser = argparse.ArgumentParser(description='Theme Manager for Dotfiles')
    parser.add_argument('command', choices=['apply', 'list', 'init'],
                       help='Command to execute')
    parser.add_argument('theme', nargs='?', help='Theme name (for apply command)')
    parser.add_argument('--config-dir', help='Custom config directory')
    
    args = parser.parse_args()
    
    generator = ThemeGenerator(args.config_dir)
    
    if args.command == 'init':
        generator.init_structure()
    elif args.command == 'list':
        generator.list_themes()
    elif args.command == 'apply':
        if not args.theme:
            print("Error: theme name required for apply command")
            sys.exit(1)
        generator.apply_theme(args.theme)


if __name__ == '__main__':
    main()
